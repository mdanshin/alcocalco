<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Взаиморасчёты по тратам — кассовый аппарат</title>
  <style>
    :root {
      --bg0: #050814;
      --bg1: #050a16;
      --card: rgba(255, 255, 255, .06);
      --card-deep: rgba(0, 0, 0, .55);
      --border: rgba(255, 255, 255, .14);
      --border-soft: rgba(255, 255, 255, .08);
      --text: #E9F0FF;
      --muted: #9AA6C9;
      --accent: #06B6D4;
      --accent2: #7C3AED;
      --danger: #F97373;
      --radius-lg: 22px;
      --radius-md: 18px;
      --shadow-strong: 0 24px 80px rgba(0, 0, 0, .65);
      --shadow-soft: 0 16px 44px rgba(0, 0, 0, .55);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(124, 58, 237, .28), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(6, 182, 212, .26), transparent 60%),
        radial-gradient(1200px 700px at 50% 100%, rgba(34, 197, 94, .22), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .grid-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .55;
      background-image:
        linear-gradient(rgba(255, 255, 255, .04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, .04) 1px, transparent 1px);
      background-size: 42px 42px, 42px 42px;
      mix-blend-mode: soft-light;
      mask-image: radial-gradient(circle at 50% 20%, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0));
      animation: gridShift 28s linear infinite;
    }

    @keyframes gridShift {
      0% {
        transform: translate3d(0, 0, 0);
      }

      100% {
        transform: translate3d(-42px, -42px, 0);
      }
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 26px;
      position: relative;
      z-index: 1;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(5, 8, 20, .92), rgba(5, 8, 20, .70));
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }

    header .inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 14px;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background:
        radial-gradient(circle at 25% 20%, rgba(255, 255, 255, .9), transparent 55%),
        conic-gradient(from 210deg, rgba(124, 58, 237, .95), rgba(6, 182, 212, .95), rgba(34, 197, 94, .9), rgba(251, 191, 36, .95), rgba(124, 58, 237, .95));
      border: 1px solid rgba(255, 255, 255, .3);
      box-shadow: 0 20px 70px rgba(0, 0, 0, .7);
      position: relative;
      overflow: hidden;
    }

    .brand-logo::after {
      content: "";
      position: absolute;
      inset: -60%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .55), transparent);
      transform: rotate(18deg) translateX(-20%);
      animation: shine 5s ease-in-out infinite;
    }

    @keyframes shine {
      0% {
        transform: rotate(18deg) translateX(-40%);
        opacity: 0;
      }

      20% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }

      100% {
        transform: rotate(18deg) translateX(40%);
        opacity: 0;
      }
    }

    .brand-text h1 {
      margin: 0;
      font-size: 15px;
      font-weight: 800;
      letter-spacing: .4px;
    }

    .brand-text p {
      margin: 3px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .header-pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .45);
      background: rgba(15, 23, 42, .85);
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-dot {
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: #22C55E;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, .35);
    }

    main {
      margin-top: 18px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media(max-width:1060px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: linear-gradient(135deg, rgba(15, 23, 42, .96), rgba(15, 23, 42, .88));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, .55);
      box-shadow: var(--shadow-strong);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      pointer-events: none;
      background:
        radial-gradient(700px 360px at 0% 0%, rgba(124, 58, 237, .24), transparent 65%),
        radial-gradient(520px 280px at 100% 0%, rgba(6, 182, 212, .24), transparent 65%),
        radial-gradient(520px 260px at 50% 100%, rgba(34, 197, 94, .18), transparent 65%);
      opacity: .9;
      mix-blend-mode: soft-light;
    }

    .panel-content {
      position: relative;
      padding: 16px 16px 18px;
    }

    h2.title {
      margin: 0 0 4px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 800;
      color: var(--muted);
    }

    p.lead {
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .register-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.95fr);
      gap: 14px;
      align-items: stretch;
      margin-top: 8px;
    }

    @media(max-width:1100px) {
      .register-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at 0 0, rgba(148, 163, 184, .16), transparent 55%), rgba(15, 23, 42, .98);
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, .55);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card-inner {
      position: relative;
      padding: 14px;
    }

    .screen {
      background: radial-gradient(circle at 10% 0, rgba(56, 189, 248, .25), transparent 55%), #020617;
      border-radius: 18px;
      border: 1px solid rgba(56, 189, 248, .45);
      padding: 10px 12px 12px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, .75), inset 0 0 0 1px rgba(15, 23, 42, .9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-variant-numeric: tabular-nums;
    }

    .screen-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: rgba(148, 163, 184, .95);
    }

    .screen-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-top: 4px;
    }

    .screen-amount {
      font-size: 28px;
      font-weight: 900;
      text-shadow: 0 0 24px rgba(56, 189, 248, .45);
    }

    .screen-amount small {
      font-size: 13px;
      font-weight: 700;
      color: rgba(148, 163, 184, .95);
      margin-left: 6px;
    }

    .field-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media(max-width:600px) {
      .field-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field label {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: .25px;
    }

    .field input,
    .field select {
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, .6);
      background: rgba(15, 23, 42, .9);
      color: var(--text);
      font-size: 13px;
      outline: none;
      min-height: 34px;
    }

    .field input:focus,
    .field select:focus {
      border-color: rgba(56, 189, 248, .8);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, .4);
    }

    .field input::placeholder {
      color: rgba(148, 163, 184, .75);
    }

    .field-full {
      grid-column: 1/-1;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(148, 163, 184, .3), rgba(15, 23, 42, 1));
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      padding: 9px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 14px 40px rgba(15, 23, 42, .9);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, .9);
      box-shadow: 0 18px 60px rgba(15, 23, 42, 1);
    }

    .btn:active {
      transform: translateY(0) scale(.98);
    }

    .btn-primary {
      border-color: rgba(56, 189, 248, .95);
      background: linear-gradient(135deg, rgba(56, 189, 248, .9), rgba(37, 99, 235, .95));
      box-shadow: 0 20px 60px rgba(37, 99, 235, .85);
    }

    .btn-danger {
      border-color: rgba(239, 68, 68, .9);
      background: linear-gradient(135deg, rgba(239, 68, 68, .9), rgba(127, 29, 29, 1));
    }

    .btn-sm {
      padding: 7px 10px;
      font-size: 11px;
    }

    .keypad {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(148, 163, 184, .45);
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .key {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, .8);
      padding: 9px 0;
      text-align: center;
      cursor: pointer;
      user-select: none;
      background: radial-gradient(circle at 0 0, rgba(148, 163, 184, .4), transparent 60%), #020617;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .75);
      font-weight: 800;
      font-size: 13px;
    }

    .key.fn {
      font-size: 11px;
      color: var(--muted);
    }

    .key.enter {
      grid-column: span 2;
      background: linear-gradient(135deg, rgba(56, 189, 248, .8), rgba(59, 130, 246, .95));
      border-color: rgba(56, 189, 248, .95);
    }

    .key:hover {
      transform: translateY(-1px);
    }

    .key:active {
      transform: translateY(0) scale(.97);
    }

    .receipt-shell {
      background: radial-gradient(circle at 0 0, rgba(148, 163, 184, .12), transparent 55%), rgba(5, 8, 22, .98);
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, .6);
      box-shadow: var(--shadow-soft);
    }

    .receipt-inner {
      padding: 14px 14px 16px;
    }

    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .receipt-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
    }

    .paper {
      background: #F5F1EB;
      color: #111827;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, .7);
      padding: 18px 12px 16px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 11px;
      line-height: 1.3;
      max-height: 320px;
      overflow: auto;
      position: relative;
      box-shadow: 0 16px 44px rgba(0, 0, 0, .65);
    }

    .paper::before,
    .paper::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      height: 26px;
      opacity: .7;
      background-size: 18px 26px;
      z-index: 1;
    }

    .paper::before {
      top: 0;
      background: radial-gradient(circle at 9px 13px, rgba(30, 64, 175, .4) 2px, transparent 3px) 0 0/18px 26px repeat-x;
    }

    .paper::after {
      bottom: 0;
      background: radial-gradient(circle at 9px 13px, rgba(30, 64, 175, .4) 2px, transparent 3px) 0 0/18px 26px repeat-x;
    }

    .receipt-body {
      position: relative;
      z-index: 2;
      white-space: pre-wrap;
    }

    .receipt-footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .expenses-section {
      margin-top: 16px;
    }

    table.list {
      width: 100%;
      border-collapse: collapse;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, .6);
      background: rgba(15, 23, 42, .98);
    }

    table.list th,
    table.list td {
      padding: 8px 9px;
      font-size: 12px;
      border-bottom: 1px solid rgba(148, 163, 184, .4);
      vertical-align: top;
    }

    table.list th {
      background: rgba(15, 23, 42, 1);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .25px;
      font-size: 11px;
    }

    table.list tr:last-child td {
      border-bottom: none;
    }

    table.list tbody tr:hover td {
      background: rgba(15, 23, 42, .9);
    }

    .mono {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-variant-numeric: tabular-nums;
    }

    .right {
      text-align: right;
    }

    .balances {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .bcard {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, .7);
      background: radial-gradient(circle at 0 0, rgba(148, 163, 184, .22), transparent 55%), rgba(15, 23, 42, .98);
      padding: 10px 12px;
      font-size: 12px;
    }

    .bcard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .bcard-name {
      font-weight: 700;
    }

    .badge {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .8);
      padding: 4px 9px;
      font-size: 11px;
      white-space: nowrap;
    }

    .badge-pos {
      border-color: rgba(34, 197, 94, .9);
      background: rgba(22, 163, 74, .2);
    }

    .badge-neg {
      border-color: rgba(239, 68, 68, .9);
      background: rgba(185, 28, 28, .18);
    }

    .badge-zero {
      border-color: rgba(148, 163, 184, .9);
      background: rgba(30, 64, 175, .2);
    }

    .bcard-line {
      color: var(--muted);
      margin-top: 2px;
    }

    .bar-wrap {
      margin-top: 6px;
      height: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 1);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, .8);
    }

    .bar {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(56, 189, 248, 1), rgba(129, 140, 248, 1));
    }

    .section-title {
      margin: 12px 0 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .3px;
      color: var(--muted);
    }

    .note {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(15, 23, 42, .9);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, .7);
      padding: 9px 10px;
    }

    .settlement-table {
      margin-top: 6px;
    }

    .row-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .pill-small {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .7);
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .consumers-box {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .consumers-box label {
      font-size: 13px;
      color: var(--text);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .6);
      padding: 6px 52px 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(15, 23, 42, .95);
      cursor: pointer;
      position: relative;
      transition: border-color .12s ease, color .12s ease, background .12s ease;
      flex: 0 0 auto;
      max-width: 100%;
    }

    .consumers-box label > span:first-of-type {
      display: inline-block;
      font-weight: 600;
      color: var(--text);
      line-height: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .consumers-box input {
      margin: 0 6px 0 0;
      width: 18px;
      height: 18px;
      flex: none;
      accent-color: #06B6D4;
    }

    .chip-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%) translateX(6px);
      display: inline-flex;
      gap: 8px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .12s ease, transform .12s ease, visibility 0s linear .12s;
    }

    .chip-action {
      width: 26px;
      height: 26px;
      padding: 0;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, .55);
      background: rgba(2, 6, 23, .65);
      color: var(--muted);
      display: grid;
      place-items: center;
      line-height: 1;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .55);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease, color .12s ease;
    }

    .chip-action:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, .9);
      color: var(--text);
      box-shadow: 0 14px 34px rgba(0, 0, 0, .65);
    }

    .chip-action:active {
      transform: translateY(0) scale(.96);
    }

    .chip-action:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, .35), 0 14px 34px rgba(0, 0, 0, .65);
      border-color: rgba(56, 189, 248, .85);
    }

    .chip-action.edit:hover {
      border-color: rgba(56, 189, 248, .95);
      background: rgba(56, 189, 248, .14);
      color: #BAE6FD;
    }

    .chip-action.delete:hover {
      border-color: rgba(239, 68, 68, .95);
      background: rgba(239, 68, 68, .16);
      color: #FCA5A5;
    }

    .consumers-box label:hover .chip-actions,
    .consumers-box label:focus-within .chip-actions {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(-50%) translateX(0);
      transition-delay: 0s;
    }

    /* компактный режим: на узких экранах чипы — две колонки */
    @media (max-width: 700px) {
      .consumers-box label {
        flex: 0 0 calc(50% - 8px);
      }
    }

    /* очень узкие экраны — три в ряд */
    @media (max-width: 420px) {
      .consumers-box label {
        flex: 0 0 calc(33.333% - 8px);
        padding-left: 8px;
        padding-right: 36px;
        font-size: 12px;
      }
      .chip-actions { right: 4px; }
    }


    .consumers-box input {
      margin: 0;
    }

    .people-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .person-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, .5);
      background: rgba(15, 23, 42, .9);
    }

    .person-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .person-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-1px);
      transition: opacity .12s ease, transform .12s ease, visibility 0s linear .12s;
    }

    .person-row:hover .person-actions,
    .person-row:focus-within .person-actions {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
      transition-delay: 0s;
    }

    table.list tbody tr [data-del] {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-1px);
      transition: opacity .12s ease, transform .12s ease, visibility 0s linear .12s;
    }

    table.list tbody tr:hover [data-del],
    table.list tbody tr:focus-within [data-del] {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
      transition-delay: 0s;
    }

    @media (hover: none) {
      .chip-actions {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transform: translateY(-50%) translateX(0);
      }

      .person-actions,
      table.list tbody tr [data-del] {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transform: none;
      }
    }

    .people-empty {
      font-size: 11px;
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, .5);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Тур: оверлей и подсказки */
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.6);
      z-index: 10000;
      pointer-events: auto;
    }

    .tour-highlight {
      position: absolute;
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(2,6,23,0.6), 0 8px 40px rgba(0,0,0,0.7);
      border: 2px solid rgba(56,189,248,0.9);
      z-index: 10001;
      transition: all .18s ease;
      background: transparent;
      pointer-events: none;
    }

    .tour-tooltip {
      position: absolute;
      max-width: 360px;
      background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(10,14,24,0.98));
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text);
      border-radius: 12px;
      padding: 14px;
      z-index: 10002;
      box-shadow: 0 18px 60px rgba(0,0,0,0.7);
      transition: all .14s ease;
      font-size: 13px;
    }

    .tour-tooltip .title {
      font-weight: 800;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .tour-tooltip .desc {
      color: var(--muted);
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .tour-tooltip .controls {
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    .tour-tooltip .controls .btn {
      padding:6px 10px;
      font-size:13px;
    }

    /* --- demo playback (virtual cursor) --- */
    .demo-curtain {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .22);
      z-index: 12000;
      pointer-events: auto;
    }

    .demo-cursor {
      position: fixed;
      left: 0;
      top: 0;
      width: 26px;
      height: 26px;
      background-repeat: no-repeat;
      background-size: 26px 26px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='26' height='26' viewBox='0 0 24 24'%3E%3Cpath fill='%23ffffff' stroke='%23000000' stroke-opacity='0.55' stroke-width='1.2' d='M4.2 2.9l14.3 9.1-8.2 1.2 3.4 7.5-2.4 1.1-3.4-7.5-5.7 6.1z'/%3E%3C/svg%3E");
      filter: drop-shadow(0 14px 30px rgba(0,0,0,0.55));
      transform: translate3d(var(--x, -9999px), var(--y, -9999px), 0) scale(var(--s, 1));
      z-index: 12010;
      pointer-events: none;
    }

    .demo-cursor.is-clicking {
      --s: 0.92;
    }

    .demo-comment {
      position: fixed;
      max-width: min(560px, calc(100vw - 36px));
      background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(10,14,24,0.98));
      border: 1px solid rgba(148,163,184,0.5);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.65);
      z-index: 12020;
      pointer-events: auto;
      transition: top .16s ease, left .16s ease;
    }

    .demo-comment .demo-title {
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .25px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .demo-comment .demo-text {
      font-size: 13px;
      line-height: 1.45;
      color: var(--text);
      margin: 0 0 10px;
    }

    .demo-comment .demo-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }

    .demo-pulse {
      outline: 4px solid rgba(6, 182, 212, .85);
      outline-offset: 8px;
      border-radius: 12px;
      box-shadow: 0 0 0 4px rgba(6, 182, 212, .35), 0 0 24px rgba(124, 58, 237, .55);
      animation: demoPulse 1.1s ease-in-out infinite;
    }

    @keyframes demoPulse {
      0% { outline-color: rgba(6, 182, 212, .7); box-shadow: 0 0 0 3px rgba(6, 182, 212, .35), 0 0 18px rgba(6, 182, 212, .35); }
      50% { outline-color: rgba(124, 58, 237, .9); box-shadow: 0 0 0 5px rgba(124, 58, 237, .45), 0 0 26px rgba(124, 58, 237, .6); }
      100% { outline-color: rgba(6, 182, 212, .7); box-shadow: 0 0 0 3px rgba(6, 182, 212, .35), 0 0 18px rgba(6, 182, 212, .35); }
    }
  </style>
</head>

<body>
  <div class="grid-bg" aria-hidden="true"></div>

  <header>
    <div class="inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-text">
          <h1>Взаиморасчёты по тратам</h1>
          <p>Вводишь, кто сколько заплатил и на кого делим — касса сама считает, кто кому должен.</p>
        </div>
      </div>
        <div style="display:flex;gap:12px;align-items:center;">
        <div class="header-pill">
          <span class="header-dot"></span>
          <span>Данные автоматически сохраняются в браузере</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btnShare" class="btn btn-sm" type="button" title="Сформировать ссылку с текущими данными">Поделиться</button>

          <button id="btnDemoPlayback" class="btn btn-sm" type="button" title="Проиграть демонстрацию работы (виртуальный курсор)">Демо</button>
          
          <button id="btnTour" class="btn btn-sm" type="button" title="Показать тур по функционалу">Показать тур</button>
        </div>
      </div>
    </div>
  </header>

  <div class="app">
    <main class="layout">
      <!-- ЛЕВАЯ ПАНЕЛЬ: касса, чек, список покупок -->
      <section class="panel">
        <div class="panel-content">
          <h2 class="title">Кассовый аппарат (ввод покупки)</h2>
          <p class="lead">Покупка = кто платил, сколько заплатил и на кого делим. Из этого касса сама посчитает, кто
            кому должен.</p>

          <div class="register-layout">
            <!-- КАССОВЫЙ БЛОК -->
            <div class="card">
              <div class="card-inner">
                <div class="screen" id="screen">
                  <div class="screen-top">
                    <span id="screenLine">Готово к работе</span>
                    <span id="screenClock">--:--:--</span>
                  </div>
                  <div class="screen-main">
                    <div class="screen-amount"><span id="screenAmount">0</span><small>₽</small></div>
                  </div>
                </div>

                <div class="field-grid" style="margin-top:10px;">
                  <div class="field">
                    <label for="payerSel">Кто платил</label>
                    <select id="payerSel"></select>
                  </div>
                  <div class="field">
                    <label for="dateInp">Дата</label>
                    <input id="dateInp" type="text" placeholder="сегодня" />
                  </div>
                  <div class="field">
                    <label for="categorySel">Категория</label>
                    <select id="categorySel"></select>
                  </div>
                  <div class="field">
                    <label for="reasonInp">Комментарий / что купили</label>
                    <input id="reasonInp" type="text" placeholder="например: алкоголь / пицца / бар" />
                  </div>
                  <div class="field field-full">
                    <label>На кого делим</label>
                    <div id="consumersBox" class="consumers-box"></div>
                  </div>
                  <div class="field field-full">
                    <label>Быстро добавить участника</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <input id="newPersonInp" type="text" placeholder="имя… (например, Лёша П.)"
                        style="flex:1;min-width:140px;" />
                      <button id="btnAddPerson" class="btn btn-sm" type="button">Добавить</button>
                    </div>
                  </div>
                </div>

                <div class="chip-row">
                  <span class="pill-small">Enter = добавить покупку</span>
                  <span class="pill-small">Esc = очистить сумму</span>
                  <span class="pill-small">Backspace = стереть символ</span>
                </div>

                <div class="keypad" aria-label="Клавиатура кассы">
                  <div class="key fn" data-key="C">C</div>
                  <div class="key fn" data-key="BS">⌫</div>
                  <div class="key fn" data-key=".">,</div>
                  <div class="key fn" data-key="00">00</div>

                  <div class="key" data-key="7">7</div>
                  <div class="key" data-key="8">8</div>
                  <div class="key" data-key="9">9</div>
                  <div class="key fn" data-key="TODAY">⟳</div>

                  <div class="key" data-key="4">4</div>
                  <div class="key" data-key="5">5</div>
                  <div class="key" data-key="6">6</div>
                  <div class="key fn" data-key="ALL">ВСЕ</div>

                  <div class="key" data-key="1">1</div>
                  <div class="key" data-key="2">2</div>
                  <div class="key" data-key="3">3</div>
                  <div class="key fn" data-key="NONE">НЕТ</div>

                  <div class="key" data-key="0">0</div>
                  <div class="key fn" data-key="X2">×2</div>
                  <div class="key enter" data-key="ENTER">Добавить (Enter)</div>
                </div>
              </div>
            </div>

            <!-- ЭМУЛЯТОР ЧЕКА -->
            <div class="receipt-shell">
              <div class="receipt-inner">
                <div class="receipt-header">
                  <div>
                    <div class="receipt-title">Эмулятор чека</div>
                    <div style="font-size:11px;color:var(--muted);">Печатает покупки и итоговый взаимозачёт</div>
                  </div>
                  <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
                    <button id="btnPrintSettlement" class="btn btn-sm btn-primary" type="button">Чек
                      взаимозачёта</button>
                    <button id="btnClearReceipt" class="btn btn-sm" type="button">Очистить ленту</button>
                  </div>
                </div>
                <div class="paper">
                  <div id="receiptBody" class="receipt-body"></div>
                </div>
                <div class="receipt-footer">
                  <span id="receiptStats">—</span>
                  <span>★ лента хранится только у тебя в браузере</span>
                </div>
              </div>
            </div>
          </div>

          <!-- СПИСОК ПОКУПОК -->
          <div class="expenses-section">
            <div class="section-title">Покупки</div>
            <table class="list" aria-label="Список покупок">
              <thead>
                <tr>
                  <th style="width:86px;">Дата</th>
                  <th>Кто платил</th>
                  <th class="right" style="width:110px;">Сумма</th>
                  <th>Категория / описание</th>
                  <th style="width:150px;">Делим на</th>
                  <th style="width:70px;" class="right">Удалить</th>
                </tr>
              </thead>
              <tbody id="expensesTbody"></tbody>
            </table>
            <div class="row-actions">
              <button id="btnDemo" class="btn btn-sm" type="button">Заполнить демо</button>
              <button id="btnClearExpenses" class="btn btn-sm btn-danger" type="button">Удалить все покупки</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ПРАВАЯ ПАНЕЛЬ: итоги и переводы -->
      <aside class="panel">
        <div class="panel-content">
          <h2 class="title">Итоги и взаимозачёт</h2>
          <p class="lead">Считаем, кто по факту переплатил, кто недоплатил и какие переводы нужны, чтобы все оказались в
            нуле.</p>

          <div class="section-title">Сводка по компании</div>
          <div class="balances" id="balancesBox"></div>

          <div class="note" id="summaryNote">Пока покупок нет.</div>

          <div class="section-title" style="margin-top:12px;">Рекомендуемые переводы</div>
          <table class="list settlement-table" aria-label="Рекомендуемые переводы">
            <thead>
              <tr>
                <th>Кто платит</th>
                <th>Кому</th>
                <th class="right" style="width:110px;">Сумма</th>
                <th>Комментарий</th>
              </tr>
            </thead>
            <tbody id="settlementTbody"></tbody>
          </table>

          <div class="note" style="margin-top:10px;">
            Алгоритм старается сделать как можно меньше переводов: самые крупные долги закрываются самыми крупными
            требованиями. Сумма балансов всех участников всегда равна нулю (с точностью до копеек).
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "expense_splitter_cash_v2";
      const TOUR_SEEN_KEY = STORAGE_KEY + "__tour_seen_v1";

      const DEFAULT_STATE = {
        people: ["Миша", "Дима", "Валерия", "Лёша К.", "Лёша Г."],
        categories: ["алкоголь", "снэки", "бар/кафе", "пицца/еда", "такси", "прочее"],
        expenses: [],
        receipt: ""
      };

      const fmt = new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 2 });
      const fmtRub = n => `${fmt.format(Number(n || 0))} ₽`;

      // DOM
      const payerSel = document.getElementById("payerSel");
      const dateInp = document.getElementById("dateInp");
      const categorySel = document.getElementById("categorySel");
      const reasonInp = document.getElementById("reasonInp");
      const consumersBox = document.getElementById("consumersBox");
      const peopleList = document.getElementById("peopleList");
      const newPersonInp = document.getElementById("newPersonInp");
      const btnAddPerson = document.getElementById("btnAddPerson");

      const screenAmount = document.getElementById("screenAmount");
      const screenLine = document.getElementById("screenLine");
      const screenClock = document.getElementById("screenClock");

      const expensesTbody = document.getElementById("expensesTbody");
      const balancesBox = document.getElementById("balancesBox");
      const settlementTbody = document.getElementById("settlementTbody");
      const summaryNote = document.getElementById("summaryNote");

      const receiptBody = document.getElementById("receiptBody");
      const receiptStats = document.getElementById("receiptStats");

      const btnPrintSettlement = document.getElementById("btnPrintSettlement");
      const btnClearReceipt = document.getElementById("btnClearReceipt");
      const btnDemo = document.getElementById("btnDemo");
      const btnClearExpenses = document.getElementById("btnClearExpenses");

      const keypadButtons = Array.from(document.querySelectorAll(".key"));

      // state
      let state = loadState();
      let amountBuffer = "0";

      // helpers
      const nowIso = () => {
        const d = new Date();
        const pad = x => String(x).padStart(2, "0");
        return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
      };
      const uid = () => Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
      const round2 = n => Math.round((Number(n) || 0) * 100 + Number.EPSILON) / 100;

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return structuredClone(DEFAULT_STATE);
          const json = JSON.parse(raw);
          return normalize(json);
        } catch (e) {
          return structuredClone(DEFAULT_STATE);
        }
      }

      // --- guided tour ---
      const tourSteps = [
        { title: "Экран кассы", desc: "Здесь отображается сумма покупки. Можно вводить числа клавишами или на экранной клавиатуре.", selector: "#screen" },
        { title: "Поделиться", desc: "Сформирует ссылку с текущими данными (участники/покупки) и скопирует её в буфер — удобно отправить в чат.", selector: "#btnShare" },
        { title: "Кто платил", desc: "Выбери, кто платил за покупку из списка плательщиков.", selector: "#payerSel" },
        { title: "На кого делим", desc: "Отметь, на кого делим покупку. Нажми ✎ чтобы переименовать участника или ✕ чтобы удалить его.", selector: "#consumersBox" },
        { title: "Добавить участника", desc: "Быстро добавь нового участника здесь.", selector: "#btnAddPerson" },
        { title: "Клавиатура кассы", desc: "Используй цифровую клавиатуру для ввода суммы или нажми 'Добавить' чтобы сохранить покупку.", selector: ".key.enter" },
        { title: "Список покупок", desc: "Здесь появляются добавленные покупки — их можно удалить по кнопке справа.", selector: "#expensesTbody" },
        { title: "Итоги и взаимозачёт", desc: "Итоговые карты показывают, кто сколько должен получить/отдать.", selector: "#balancesBox" }
      ];

      function wasTourSeen() {
        try { return localStorage.getItem(TOUR_SEEN_KEY) === '1'; } catch (e) { return true; }
      }

      function markTourSeen() {
        try { localStorage.setItem(TOUR_SEEN_KEY, '1'); } catch (e) { /* ignore */ }
      }

      let _tour = { overlay: null, highlight: null, tooltip: null, idx: 0, onKey: null };

      function createTourElements() {
        if (_tour.overlay) return;
        const ov = document.createElement('div'); ov.className = 'tour-overlay';
        const hl = document.createElement('div'); hl.className = 'tour-highlight';
        const tt = document.createElement('div'); tt.className = 'tour-tooltip';
        tt.innerHTML = `<div class="title"></div><div class="desc"></div><div class="controls"><button class="btn" data-role="prev">Назад</button><button class="btn btn-primary" data-role="next">Далее</button><button class="btn" data-role="close">Закрыть</button></div>`;
        document.body.appendChild(ov);
        document.body.appendChild(hl);
        document.body.appendChild(tt);
        _tour.overlay = ov; _tour.highlight = hl; _tour.tooltip = tt;

        tt.querySelector('[data-role="next"]').addEventListener('click', () => showStep(_tour.idx + 1));
        tt.querySelector('[data-role="prev"]').addEventListener('click', () => showStep(_tour.idx - 1));
        tt.querySelector('[data-role="close"]').addEventListener('click', closeTour);
      }

      function startTour() {
        markTourSeen();
        createTourElements();
        _tour.idx = 0; showStep(0);
        _tour.onKey = (e) => {
          if (e.key === 'Escape') closeTour();
          if (e.key === 'ArrowRight' || e.key === 'Enter') showStep(_tour.idx + 1);
          if (e.key === 'ArrowLeft') showStep(_tour.idx - 1);
        };
        document.addEventListener('keydown', _tour.onKey);
      }

      function closeTour() {
        if (_tour.overlay) { _tour.overlay.remove(); _tour.overlay = null; }
        if (_tour.highlight) { _tour.highlight.remove(); _tour.highlight = null; }
        if (_tour.tooltip) { _tour.tooltip.remove(); _tour.tooltip = null; }
        if (_tour.onKey) { document.removeEventListener('keydown', _tour.onKey); _tour.onKey = null; }
      }

      function showStep(i) {
        if (i < 0) i = 0; if (i >= tourSteps.length) { closeTour(); return; }
        _tour.idx = i;
        const step = tourSteps[i];
        const el = document.querySelector(step.selector) || document.body;
        const rect = el.getBoundingClientRect();
        const pad = 10;
        const hl = _tour.highlight; const tt = _tour.tooltip; const ov = _tour.overlay;
        if (!hl || !tt || !ov) return;
        ov.style.display = 'block'; hl.style.display = 'block'; tt.style.display = 'block';

        // highlight placement
        const top = Math.max(8, rect.top - pad + window.scrollY);
        const left = Math.max(8, rect.left - pad + window.scrollX);
        const width = Math.max(44, rect.width + pad * 2);
        const height = Math.max(28, rect.height + pad * 2);
        hl.style.top = top + 'px'; hl.style.left = left + 'px'; hl.style.width = width + 'px'; hl.style.height = height + 'px';

        // tooltip content
        tt.querySelector('.title').textContent = step.title || '';
        tt.querySelector('.desc').textContent = step.desc || '';

        // controls state
        tt.querySelector('[data-role="prev"]').style.display = i === 0 ? 'none' : 'inline-flex';
        tt.querySelector('[data-role="next"]').textContent = i === tourSteps.length - 1 ? 'Готово' : 'Далее';

        // position tooltip: try above, else below
        const ttRect = tt.getBoundingClientRect();
        const spaceAbove = rect.top - 12;
        const spaceBelow = window.innerHeight - (rect.bottom + 12);
        let ttTop, ttLeft;
        if (spaceAbove > ttRect.height + 16) {
          ttTop = left; // placeholder
        }
        // compute left centered to element
        ttLeft = left + Math.max(0, (width - ttRect.width) / 2);

        // prefer above
        if (spaceAbove > ttRect.height + 16) {
          tt.style.top = Math.max(8, rect.top - ttRect.height - 16 + window.scrollY) + 'px';
        } else {
          tt.style.top = Math.min(window.scrollY + window.innerHeight - ttRect.height - 8, rect.bottom + 16 + window.scrollY) + 'px';
        }
        // left clamp
        const leftClamp = Math.min(Math.max(8 + window.scrollX, left + (width - ttRect.width) / 2 + window.scrollX), window.scrollX + window.innerWidth - ttRect.width - 8);
        tt.style.left = leftClamp + 'px';
      }

      document.getElementById('btnTour').addEventListener('click', () => startTour());

      // --- demo playback (scripted user actions) ---
      const _demo = {
        running: false,
        token: 0,
        curtain: null,
        cursor: null,
        comment: null,
        lastTargetRect: null,
        cursorX: -9999,
        cursorY: -9999,
        keyHandler: null
      };

      const DEMO_SPEED = 3;

      function demoMs(ms) {
        return Math.round(ms * DEMO_SPEED);
      }

      function cssEscapeSafe(s) {
        try {
          if (window.CSS && typeof window.CSS.escape === 'function') return window.CSS.escape(String(s));
        } catch (e) { /* ignore */ }
        return String(s).replace(/[^a-zA-Z0-9_-]/g, (ch) => "\\" + ch);
      }

      function demoEnsureUI() {
        if (_demo.curtain) return;
        const curtain = document.createElement('div');
        curtain.className = 'demo-curtain';
        const cursor = document.createElement('div');
        cursor.className = 'demo-cursor';
        const comment = document.createElement('div');
        comment.className = 'demo-comment';
        comment.innerHTML = `
          <div class="demo-title">Демонстрация</div>
          <p class="demo-text">—</p>
          <div class="demo-actions">
            <span style="font-size:12px;color:var(--muted);margin-right:auto;">Esc — остановить</span>
            <button type="button" class="btn btn-sm" data-role="stop">Остановить</button>
          </div>
        `;
        document.body.appendChild(curtain);
        document.body.appendChild(cursor);
        document.body.appendChild(comment);
        _demo.curtain = curtain;
        _demo.cursor = cursor;
        _demo.comment = comment;

        comment.querySelector('[data-role="stop"]').addEventListener('click', () => demoStop());
        _demo.keyHandler = (e) => {
          if (e.key === 'Escape') {
            e.preventDefault();
            demoStop();
          }
        };
        document.addEventListener('keydown', _demo.keyHandler, true);
      }

      function demoTearDownUI() {
        if (_demo.keyHandler) {
          document.removeEventListener('keydown', _demo.keyHandler, true);
          _demo.keyHandler = null;
        }
        if (_demo.comment) { _demo.comment.remove(); _demo.comment = null; }
        if (_demo.cursor) { _demo.cursor.remove(); _demo.cursor = null; }
        if (_demo.curtain) { _demo.curtain.remove(); _demo.curtain = null; }
      }

      function demoStop() {
        // Всегда закрываем UI и инвалидируем текущий прогон,
        // даже если воспроизведение уже дошло до конца.
        _demo.running = false;
        _demo.token++;
        demoTearDownUI();
        try { renderScreen('Демо остановлено'); } catch (e) { /* ignore */ }
      }

      function demoSleep(ms, token) {
        return new Promise((resolve) => {
          const t = setTimeout(() => {
            clearTimeout(t);
            resolve();
          }, demoMs(ms));
        }).then(() => {
          if (!_demo.running || token !== _demo.token) throw new Error('demo-cancelled');
        });
      }

      function demoSetText(text) {
        if (!_demo.comment) return;
        const p = _demo.comment.querySelector('.demo-text');
        if (p) p.textContent = text;
        if (_demo.lastTargetRect) {
          requestAnimationFrame(() => demoPlaceCommentNearRect(_demo.lastTargetRect));
        }
      }

      function demoClearPulse() {
        document.querySelectorAll('.demo-pulse').forEach(el => el.classList.remove('demo-pulse'));
      }

      async function demoScrollIntoView(el, token) {
        try { el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); } catch (e) { /* ignore */ }
        await demoSleep(520, token);
      }

      async function demoMoveCursorTo(el, token, duration = 520) {
        if (!_demo.cursor) return;
        const rect = el.getBoundingClientRect();
        // target near top-left (more like a real pointer)
        const jitterX = (Math.random() - 0.5) * 6;
        const jitterY = (Math.random() - 0.5) * 6;
        const targetX = Math.round(rect.left + 12 + jitterX);
        const targetY = Math.round(rect.top + 12 + jitterY);
        const startX = _demo.cursorX;
        const startY = _demo.cursorY;
        const start = performance.now();

        const ease = (t) => (t < 0.5) ? (4 * t * t * t) : (1 - Math.pow(-2 * t + 2, 3) / 2);

        await new Promise((resolve) => {
          const frame = (now) => {
            if (!_demo.running || token !== _demo.token) return resolve();
            const t = Math.min(1, (now - start) / Math.max(1, demoMs(duration)));
            const k = ease(t);
            const x = Math.round(startX + (targetX - startX) * k);
            const y = Math.round(startY + (targetY - startY) * k);
            _demo.cursorX = x; _demo.cursorY = y;
            _demo.cursor.style.setProperty('--x', x + 'px');
            _demo.cursor.style.setProperty('--y', y + 'px');
            if (t < 1) requestAnimationFrame(frame);
            else resolve();
          };
          requestAnimationFrame(frame);
        });
      }

      function demoClickVisual() {
        if (!_demo.cursor) return;
        _demo.cursor.classList.add('is-clicking');
        setTimeout(() => { try { _demo.cursor && _demo.cursor.classList.remove('is-clicking'); } catch (e) { } }, 120);
      }

      function demoGetEl(selector) {
        const el = document.querySelector(selector);
        if (!el) throw new Error('demo-missing-element:' + selector);
        return el;
      }

      function demoPlaceCommentNearRect(rect) {
        if (!_demo.comment || !rect) return;
        const comment = _demo.comment;
        const margin = 12;
        const viewW = window.innerWidth;
        const viewH = window.innerHeight;

        const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

        // расширяем зону безопасности вокруг цели (учёт подсветки)
        const safePad = 18;
        const safeRect = {
          left: Math.max(0, rect.left - safePad),
          right: Math.min(viewW, rect.right + safePad),
          top: Math.max(0, rect.top - safePad),
          bottom: Math.min(viewH, rect.bottom + safePad)
        };

        const areas = [
          // right of target
          {
            name: 'right',
            left: safeRect.right + margin,
            top: margin,
            width: Math.max(0, viewW - safeRect.right - margin * 2),
            height: Math.max(0, viewH - margin * 2)
          },
          // left of target
          {
            name: 'left',
            left: margin,
            top: margin,
            width: Math.max(0, safeRect.left - margin * 2),
            height: Math.max(0, viewH - margin * 2)
          },
          // below target
          {
            name: 'below',
            left: margin,
            top: safeRect.bottom + margin,
            width: Math.max(0, viewW - margin * 2),
            height: Math.max(0, viewH - safeRect.bottom - margin * 2)
          },
          // above target
          {
            name: 'above',
            left: margin,
            top: margin,
            width: Math.max(0, viewW - margin * 2),
            height: Math.max(0, safeRect.top - margin * 2)
          }
        ].filter(a => a.width > 0 && a.height > 0);

        // pick the largest available area (to avoid overlap by construction)
        let area = areas.sort((a, b) => (b.width * b.height) - (a.width * a.height))[0];

        if (!area) return; // no safe space

        // fit comment into chosen area to guarantee no overlap
        const maxW = Math.min(560, Math.max(0, area.width));
        const maxH = Math.max(0, area.height);
        comment.style.maxWidth = Math.round(maxW) + 'px';
        comment.style.width = Math.round(maxW) + 'px';
        comment.style.maxHeight = Math.round(maxH) + 'px';
        comment.style.overflow = area.height < 160 ? 'auto' : 'visible';

        // measure after sizing
        const c = comment.getBoundingClientRect();
        const cw = c.width || Math.min(maxW || 0, 360);
        const ch = c.height || Math.max(0, Math.min(maxH || 0, 120));

        let left;
        let top;

        if (area.name === 'right') {
          left = area.left;
          top = clamp(safeRect.top, area.top, area.top + area.height - ch);
        } else if (area.name === 'left') {
          left = area.left + area.width - cw;
          top = clamp(safeRect.top, area.top, area.top + area.height - ch);
        } else if (area.name === 'below') {
          left = clamp(safeRect.left, area.left, area.left + area.width - cw);
          top = area.top;
        } else if (area.name === 'above') {
          left = clamp(safeRect.left, area.left, area.left + area.width - cw);
          top = area.top + area.height - ch;
        }

        comment.style.left = Math.round(left) + 'px';
        comment.style.top = Math.round(top) + 'px';
      }

      async function demoPoint(selector, token) {
        const el = demoGetEl(selector);
        demoClearPulse();
        el.classList.add('demo-pulse');
        await demoScrollIntoView(el, token);
        await demoMoveCursorTo(el, token);
        _demo.lastTargetRect = el.getBoundingClientRect();
        demoPlaceCommentNearRect(_demo.lastTargetRect);
        return el;
      }

      async function demoClick(selector, token) {
        const el = await demoPoint(selector, token);
        demoClickVisual();
        try { el.focus && el.focus(); } catch (e) { /* ignore */ }
        try { el.click(); } catch (e) { /* ignore */ }
        await demoSleep(220, token);
        return el;
      }

      async function demoType(selector, token, text, opts) {
        const options = Object.assign({ clear: true, delay: 38 }, opts || {});
        const el = await demoPoint(selector, token);
        demoClickVisual();
        try { el.focus(); } catch (e) { /* ignore */ }
        if (options.clear) {
          try { el.value = ''; el.dispatchEvent(new Event('input', { bubbles: true })); } catch (e) { /* ignore */ }
          await demoSleep(120, token);
        }
        const s = String(text);
        for (const ch of s) {
          try {
            el.value = (el.value || '') + ch;
            el.dispatchEvent(new Event('input', { bubbles: true }));
          } catch (e) { /* ignore */ }
          await demoSleep(options.delay, token);
        }
        try { el.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { /* ignore */ }
        await demoSleep(180, token);
        return el;
      }

      async function demoSelectByText(selector, token, text) {
        const el = await demoPoint(selector, token);
        demoClickVisual();
        const target = String(text);
        let chosen = null;
        Array.from(el.options || []).forEach(o => {
          if (!chosen && String(o.textContent).trim() === target) chosen = o;
        });
        if (!chosen && el.options && el.options.length) chosen = el.options[0];
        if (chosen) {
          el.value = chosen.value;
          el.dispatchEvent(new Event('change', { bubbles: true }));
        }
        await demoSleep(220, token);
        return el;
      }

      async function demoPressKeypad(key, token) {
        const selector = key === 'ENTER' ? '.key.enter' : `.key[data-key="${cssEscapeSafe(key)}"]`;
        await demoClick(selector, token);
      }

      async function demoSetConsumers(names, token) {
        await demoSetText('Выбираю, на кого делим покупку…');
        await demoPressKeypad('NONE', token);
        await demoSleep(180, token);
        for (const name of names) {
          const sel = `.consumer-checkbox[data-name="${cssEscapeSafe(name)}"]`;
          const box = demoGetEl(sel);
          const label = box.closest('label') || box;
          await demoScrollIntoView(label, token);
          await demoMoveCursorTo(label, token, 420);
          demoClickVisual();
          try { label.click(); } catch (e) { /* ignore */ }
          await demoSleep(180, token);
        }
      }

      async function runDemoPlayback() {
        if (_demo.running) return;
        const ok = confirm('Проиграть демонстрацию? Текущие данные будут заменены демо-набором (можно остановить Esc).');
        if (!ok) return;

        try { closeTour(); } catch (e) { /* ignore */ }

        _demo.running = true;
        _demo.token++;
        const token = _demo.token;
        _demo.cursorX = -120; _demo.cursorY = -120;
        demoEnsureUI();
        demoSetText('Сейчас покажу, как это работает: добавим участников и внесём пару покупок.');

        try { window.__demoPlaybackActive = true; } catch (e) { /* ignore */ }

        // reset state for a clean demo
        try {
          state = normalize({
            people: ['Миша'],
            categories: DEFAULT_STATE.categories.slice(),
            expenses: [],
            receipt: receiptHeader('ДЕМО') + 'Старт демонстрации.\n'
          });
          saveState();
          renderPeopleAndCategories();
          setAmountBuffer('0');
          renderAll();
        } catch (e) { /* ignore */ }

        try {
          await demoSleep(650, token);

          demoSetText('Сначала добавим ещё пару участников.');
          await demoType('#newPersonInp', token, 'Дима');
          await demoClick('#btnAddPerson', token);
          await demoSleep(350, token);

          await demoType('#newPersonInp', token, 'Валерия');
          await demoClick('#btnAddPerson', token);
          await demoSleep(520, token);

          demoSetText('Теперь внесём покупку: кто платил, сумма и на кого делим.');
          await demoSelectByText('#payerSel', token, 'Дима');
          await demoSelectByText('#categorySel', token, 'бар/кафе');
          await demoType('#reasonInp', token, 'бар');
          await demoPressKeypad('ALL', token);

          demoSetText('Ввожу сумму на виртуальной клавиатуре и добавляю покупку.');
          await demoPressKeypad('1', token);
          await demoPressKeypad('2', token);
          await demoPressKeypad('0', token);
          await demoPressKeypad('0', token);
          await demoPressKeypad('ENTER', token);
          await demoSleep(650, token);

          demoSetText('Вторая покупка будет только на часть участников.');
          await demoSelectByText('#payerSel', token, 'Миша');
          await demoSelectByText('#categorySel', token, 'пицца/еда');
          await demoType('#reasonInp', token, 'пицца');
          await demoSetConsumers(['Миша', 'Валерия'], token);

          demoSetText('Сумма 900 и добавляем.');
          await demoPressKeypad('9', token);
          await demoPressKeypad('0', token);
          await demoPressKeypad('0', token);
          await demoPressKeypad('ENTER', token);
          await demoSleep(850, token);

          demoSetText('Готово: покупки в списке, справа пересчитаны итоги и рекомендованные переводы.');
          demoSetText('1) Итоги и взаимозачёт смотри справа — здесь видно, кто в плюсе/минусе.');
          await demoPoint('#balancesBox', token);
          await demoSleep(1200, token);

          demoSetText('2) Рекомендуемые переводы ниже: кто кому и сколько переводит, чтобы все вышли в ноль.');
          await demoPoint('.settlement-table', token);
          await demoSleep(1200, token);

          demoSetText('3) Если нужно поделиться расчётами — жми «Поделиться»: ссылка с текущими данными сформируется и скопируется.');
          await demoClick('#btnShare', token);
          await demoSleep(900, token);

          demoSetText('Демо завершено. Нажми «Остановить» или Esc, чтобы закрыть.');
        } catch (e) {
          // cancelled or missing element
        } finally {
          // leave UI until user closes, but stop the engine
          _demo.running = false;
          demoClearPulse();
          try { window.__demoPlaybackActive = false; } catch (e) { /* ignore */ }
        }
      }

      const btnDemoPlayback = document.getElementById('btnDemoPlayback');
      if (btnDemoPlayback) {
        btnDemoPlayback.addEventListener('click', () => {
          if (_demo.running) demoStop();
          else runDemoPlayback();
        });
      }

      // --- share via link (LZ + base64url, корректно для UTF-16) ---
      var LZ = (function() {
        // minimal LZ-String subset: compressToEncodedURIComponent / decompressFromEncodedURIComponent
        // IMPORTANT: transport encoding must be robust in URLs and messengers.
        // We use: compressed UTF-16 string -> bytes (LE) -> base64url.
        var f = String.fromCharCode;

        function compress(uncompressed) {
          if (uncompressed == null) return "";
          var i, value, context_dictionary = {}, context_dictionaryToCreate = {}, context_c = "", context_wc = "", context_w = "", context_enlargeIn = 2, context_dictSize = 3, context_numBits = 2, context_data = [], context_data_val = 0, context_data_position = 0;
          for (i = 0; i < uncompressed.length; i += 1) {
            context_c = uncompressed.charAt(i);
            if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
              context_dictionary[context_c] = context_dictSize++;
              context_dictionaryToCreate[context_c] = true;
            }
            context_wc = context_w + context_c;
            if (Object.prototype.hasOwnProperty.call(context_dictionary, context_wc)) {
              context_w = context_wc;
            } else {
              if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
                value = context_w.charCodeAt(0);
                if (value < 256) {
                  for (var j = 0; j < context_numBits; j++) {
                    context_data_val = (context_data_val << 1);
                    if (context_data_position == 15) {
                      context_data_position = 0;
                      context_data.push(f(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                  }
                  for (var k = 0; k < 8; k++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == 15) {
                      context_data_position = 0;
                      context_data.push(f(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                    value = value >> 1;
                  }
                } else {
                  value = 1;
                  for (var j = 0; j < context_numBits; j++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == 15) {
                      context_data_position = 0;
                      context_data.push(f(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                    value = value >> 1;
                  }
                  value = context_w.charCodeAt(0);
                  for (var k = 0; k < 16; k++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == 15) {
                      context_data_position = 0;
                      context_data.push(f(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                    value = value >> 1;
                  }
                }
                context_enlargeIn--;
                if (context_enlargeIn == 0) {
                  context_enlargeIn = Math.pow(2, context_numBits);
                  context_numBits++;
                }
                delete context_dictionaryToCreate[context_w];
              } else {
                value = context_dictionary[context_w];
                for (var j = 0; j < context_numBits; j++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == 15) {
                    context_data_position = 0;
                    context_data.push(f(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
              }
              context_enlargeIn--;
              if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
              }
              context_dictionary[context_wc] = context_dictSize++;
              context_w = String(context_c);
            }
          }

          if (context_w !== "") {
            if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
              value = context_w.charCodeAt(0);
              if (value < 256) {
                for (var j = 0; j < context_numBits; j++) {
                  context_data_val = (context_data_val << 1);
                  if (context_data_position == 15) {
                    context_data_position = 0;
                    context_data.push(f(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                }
                for (var k = 0; k < 8; k++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == 15) {
                    context_data_position = 0;
                    context_data.push(f(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
              } else {
                value = 1;
                for (var j = 0; j < context_numBits; j++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == 15) {
                    context_data_position = 0;
                    context_data.push(f(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
                value = context_w.charCodeAt(0);
                for (var k = 0; k < 16; k++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == 15) {
                    context_data_position = 0;
                    context_data.push(f(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
              }
              context_enlargeIn--;
              if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
              }
              delete context_dictionaryToCreate[context_w];
            } else {
              value = context_dictionary[context_w];
              for (var j = 0; j < context_numBits; j++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == 15) {
                  context_data_position = 0;
                  context_data.push(f(context_data_val));
                  context_data_val = 0;
                } else {
                  context_data_position++;
                }
                value = value >> 1;
              }
            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
              context_enlargeIn = Math.pow(2, context_numBits);
              context_numBits++;
            }
          }

          // mark the end
          value = 2;
          for (var j = 0; j < context_numBits; j++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position == 15) {
              context_data_position = 0;
              context_data.push(f(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }
          // flush
          while (true) {
            context_data_val = (context_data_val << 1);
            if (context_data_position == 15) {
              context_data.push(f(context_data_val));
              break;
            } else context_data_position++;
          }
          return context_data.join('');
        }

        function decompress(compressed) {
          if (compressed == null) return "";
          if (compressed == "") return null;
          var i, dictionary = [0,1,2], enlargeIn = 4, dictSize = 4, numBits = 3, entry = "", result = [], w, bits, resb, maxpower, power, c, data = { val: compressed.charCodeAt(0), position: 32768, index: 1 };

          function readBit() {
            var res = (data.val & data.position) !== 0 ? 1 : 0;
            data.position >>= 1;
            if (data.position === 0) {
              data.position = 32768;
              data.val = compressed.charCodeAt(data.index++);
            }
            return res;
          }

          var next = 0;
          var bitsVal = 0;
          maxpower = Math.pow(2,2);
          power = 1;
          while (power != maxpower) {
            resb = readBit();
            bitsVal |= (resb * power);
            power <<= 1;
          }
          var dictEntry;
          switch (bitsVal) {
            case 0:
              bits = 0;
              maxpower = Math.pow(2,8);
              power = 1;
              while (power != maxpower) {
                resb = readBit();
                bits |= (resb * power);
                power <<= 1;
              }
              c = f(bits);
              break;
            case 1:
              bits = 0;
              maxpower = Math.pow(2,16);
              power = 1;
              while (power != maxpower) {
                resb = readBit();
                bits |= (resb * power);
                power <<= 1;
              }
              c = f(bits);
              break;
            case 2:
              return '';
          }
          dictionary[3] = c;
          w = c;
          result.push(c);
          while (true) {
            if (data.index > compressed.length) return '';
            bitsVal = 0;
            maxpower = Math.pow(2,numBits);
            power = 1;
            while (power != maxpower) {
              resb = readBit();
              bitsVal |= (resb * power);
              power <<= 1;
            }
            switch (bitsVal) {
              case 0:
                bits = 0;
                maxpower = Math.pow(2,8);
                power = 1;
                while (power != maxpower) {
                  resb = readBit();
                  bits |= (resb * power);
                  power <<= 1;
                }
                dictionary[dictSize++] = f(bits);
                bitsVal = dictSize-1;
                enlargeIn--;
                break;
              case 1:
                bits = 0;
                maxpower = Math.pow(2,16);
                power = 1;
                while (power != maxpower) {
                  resb = readBit();
                  bits |= (resb * power);
                  power <<= 1;
                }
                dictionary[dictSize++] = f(bits);
                bitsVal = dictSize-1;
                enlargeIn--;
                break;
              case 2:
                return result.join('');
            }
            if (enlargeIn == 0) {
              enlargeIn = Math.pow(2, numBits);
              numBits++;
            }
            if (dictionary[bitsVal]) {
              entry = dictionary[bitsVal];
            } else {
              if (typeof w === 'string' && w.length) {
                entry = w + w.charAt(0);
              } else {
                // corrupted stream / unexpected state
                return null;
              }
            }
            result.push(entry);
            // add w+entry[0]
            dictionary[dictSize++] = w + entry.charAt(0);
            enlargeIn--;
            w = entry;
            if (enlargeIn == 0) {
              enlargeIn = Math.pow(2, numBits);
              numBits++;
            }
          }
        }

        // Backwards-compatibility decoder for buggy streams produced by an earlier version
        // where literals with marker 0 were written as 16 bits (instead of 8).
        function decompressBuggy8As16(compressed) {
          if (compressed == null) return "";
          if (compressed == "") return null;
          var dictionary = [0, 1, 2], enlargeIn = 4, dictSize = 4, numBits = 3, entry = "", result = [], w, bits, resb, maxpower, power, c,
            data = { val: compressed.charCodeAt(0), position: 32768, index: 1 };

          function readBit() {
            var res = (data.val & data.position) !== 0 ? 1 : 0;
            data.position >>= 1;
            if (data.position === 0) {
              data.position = 32768;
              data.val = compressed.charCodeAt(data.index++);
            }
            return res;
          }

          var bitsVal = 0;
          maxpower = Math.pow(2, 2);
          power = 1;
          while (power != maxpower) {
            resb = readBit();
            bitsVal |= (resb * power);
            power <<= 1;
          }

          switch (bitsVal) {
            case 0:
              bits = 0;
              maxpower = Math.pow(2, 16);
              power = 1;
              while (power != maxpower) {
                resb = readBit();
                bits |= (resb * power);
                power <<= 1;
              }
              c = f(bits);
              break;
            case 1:
              bits = 0;
              maxpower = Math.pow(2, 16);
              power = 1;
              while (power != maxpower) {
                resb = readBit();
                bits |= (resb * power);
                power <<= 1;
              }
              c = f(bits);
              break;
            case 2:
              return '';
          }

          dictionary[3] = c;
          w = c;
          result.push(c);

          while (true) {
            if (data.index > compressed.length) return '';
            bitsVal = 0;
            maxpower = Math.pow(2, numBits);
            power = 1;
            while (power != maxpower) {
              resb = readBit();
              bitsVal |= (resb * power);
              power <<= 1;
            }
            switch (bitsVal) {
              case 0:
                bits = 0;
                maxpower = Math.pow(2, 16);
                power = 1;
                while (power != maxpower) {
                  resb = readBit();
                  bits |= (resb * power);
                  power <<= 1;
                }
                dictionary[dictSize++] = f(bits);
                bitsVal = dictSize - 1;
                enlargeIn--;
                break;
              case 1:
                bits = 0;
                maxpower = Math.pow(2, 16);
                power = 1;
                while (power != maxpower) {
                  resb = readBit();
                  bits |= (resb * power);
                  power <<= 1;
                }
                dictionary[dictSize++] = f(bits);
                bitsVal = dictSize - 1;
                enlargeIn--;
                break;
              case 2:
                return result.join('');
            }

            if (enlargeIn == 0) {
              enlargeIn = Math.pow(2, numBits);
              numBits++;
            }

            if (dictionary[bitsVal]) {
              entry = dictionary[bitsVal];
            } else {
              if (typeof w === 'string' && w.length) {
                entry = w + w.charAt(0);
              } else {
                return null;
              }
            }
            result.push(entry);
            dictionary[dictSize++] = w + entry.charAt(0);
            enlargeIn--;
            w = entry;
            if (enlargeIn == 0) {
              enlargeIn = Math.pow(2, numBits);
              numBits++;
            }
          }
        }

        function u16ToBase64Url(u16str) {
          const s = String(u16str || "");
          const bytes = new Uint8Array(s.length * 2);
          for (let i = 0; i < s.length; i++) {
            const code = s.charCodeAt(i);
            bytes[i * 2] = code & 0xff;
            bytes[i * 2 + 1] = (code >>> 8) & 0xff;
          }

          let bin = "";
          const CHUNK = 8192;
          for (let i = 0; i < bytes.length; i += CHUNK) {
            const sub = bytes.subarray(i, i + CHUNK);
            let part = "";
            for (let j = 0; j < sub.length; j++) part += String.fromCharCode(sub[j]);
            bin += part;
          }

          const b64 = btoa(bin);
          return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
        }

        function base64UrlToU16(b64url) {
          let b64 = String(b64url || "").replace(/-/g, "+").replace(/_/g, "/");
          while (b64.length % 4) b64 += "=";

          const bin = atob(b64);
          if (bin.length % 2) throw new Error("Bad u16 payload length");

          let out = "";
          for (let i = 0; i < bin.length; i += 2) {
            const lo = bin.charCodeAt(i);
            const hi = bin.charCodeAt(i + 1);
            out += f(lo | (hi << 8));
          }
          return out;
        }

        function compressToEncodedURIComponent(input) {
          if (input == null) return '';
          const compressedU16 = compress(String(input));
          return u16ToBase64Url(compressedU16);
        }

        function decompressFromEncodedURIComponent(input) {
          try {
            if (input == null || input === '') return '';
            const compressedU16 = base64UrlToU16(String(input));
            const out = decompress(compressedU16);
            if (out != null && out !== '') return out;
            // fallback for links produced by older buggy compressor
            return decompressBuggy8As16(compressedU16);
          } catch (e) {
            return null;
          }
        }

        // Legacy decoder for old shared links (pair-mapping over keyStrUriSafe).
        // Kept for backwards compatibility only.
        function legacyDecompressFromUriSafePairMapping(input) {
          if (input == null || input === '') return '';
          const keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-_*";
          if (input.length % 2 !== 0) return null;
          let tmp = '';
          for (let i = 0; i < input.length; i += 2) {
            const a = keyStrUriSafe.indexOf(input.charAt(i));
            const b = keyStrUriSafe.indexOf(input.charAt(i + 1));
            if (a < 0 || b < 0) return null;
            tmp += f((a << 6) | b);
          }
          try {
            return decompress(tmp);
          } catch (e) {
            return null;
          }
        }

        return {
          compressToEncodedURIComponent: compressToEncodedURIComponent,
          decompressFromEncodedURIComponent: decompressFromEncodedURIComponent,
          legacyDecompressFromUriSafePairMapping: legacyDecompressFromUriSafePairMapping
        };
      })();
      // expose for debugging in console
      try { window.LZ = LZ; } catch (e) { /* ignore */ }

      const ShareCodec = {
        encode: (jsonStr) => LZ.compressToEncodedURIComponent(String(jsonStr == null ? '' : jsonStr)),
        decode: (payload) => LZ.decompressFromEncodedURIComponent(String(payload == null ? '' : payload)),
        decodeLegacy: (payload) => LZ.legacyDecompressFromUriSafePairMapping(String(payload == null ? '' : payload)),
      };
      try { window.ShareCodec = ShareCodec; } catch (e) { /* ignore */ }

      // simple toast helper
      function showToast(msg, duration = 2200) {
        let toast = document.getElementById('appToast');
        if (!toast) {
          toast = document.createElement('div');
          toast.id = 'appToast';
          toast.style.position = 'fixed';
          toast.style.right = '18px';
          toast.style.top = '18px';
          toast.style.zIndex = 11000;
          toast.style.pointerEvents = 'auto';
          document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.background = 'linear-gradient(180deg, rgba(15,23,42,0.98), rgba(10,14,24,0.98))';
        toast.style.color = 'var(--text)';
        toast.style.padding = '10px 14px';
        toast.style.border = '1px solid rgba(148,163,184,0.5)';
        toast.style.borderRadius = '10px';
        toast.style.boxShadow = '0 12px 40px rgba(0,0,0,0.6)';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-6px)';
        toast.style.transition = 'opacity .18s ease, transform .18s ease';
        requestAnimationFrame(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; });
        clearTimeout(toast._t);
        toast._t = setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-6px)'; }, duration);
      }

      function makeShareUrl() {
        try {
          const shareState = { people: state.people, categories: state.categories, expenses: state.expenses };
          const data = JSON.stringify(shareState);
          const encoded = ShareCodec.encode(data);

          // на file:// origin может быть "null" — делаем максимально устойчивую базу
          const base = (location.origin && location.origin !== 'null')
            ? (location.origin + location.pathname)
            : (location.pathname || '');

          return base + '?data=' + encoded;
        } catch (e) { return null; }
      }
      // expose helper for console debugging: in DevTools run `copy(window.makeShareUrl())`
      try { window.makeShareUrl = makeShareUrl; } catch (e) { /* ignore */ }

      function handleShareClick() {
        const url = makeShareUrl();
        if (!url) { showToast('Не удалось сформировать ссылку'); return; }
        const demoActive = !!(window && window.__demoPlaybackActive);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            showToast('Ссылка скопирована в буфер обмена');
          }).catch(() => {
            if (demoActive) {
              showToast('Ссылка сформирована (копирование может быть заблокировано браузером)');
              return;
            }
            prompt('Скопируй ссылку вручную:', url);
          });
        } else {
          if (demoActive) {
            showToast('Ссылка сформирована (копирование может быть недоступно в этом браузере)');
            return;
          }
          prompt('Скопируй ссылку вручную:', url);
        }
      }

      document.getElementById('btnShare').addEventListener('click', handleShareClick);

      // parse shared payload from various formats and return parsed JSON or null
      function parseShareString(rawParam) {
        if (!rawParam) return null;

        // normalize: some messengers add % encoding or whitespace
        let param = String(rawParam);
        for (let k = 0; k < 2; k++) {
          try {
            if (/%[0-9A-Fa-f]{2}/.test(param)) param = decodeURIComponent(param);
          } catch (e) { /* ignore */ }
        }
        param = param.trim().replace(/\s+/g, '');

        // 1) preferred: ShareCodec (LZ+base64url)
        try {
          const out = ShareCodec.decode(param);
          if (out) {
            try { return JSON.parse(out); } catch (e) { /* ignore */ }
          }
        } catch (e) { /* ignore */ }

        // 2) legacy links: old pair-mapping codec
        try {
          const out = ShareCodec.decodeLegacy(param);
          if (out) {
            try { return JSON.parse(out); } catch (e) { /* ignore */ }
          }
        } catch (e) { /* ignore */ }

        // 3) raw JSON base64/base64url variant (old debug / manual shares)
        try {
          let b = param.replace(/-/g, '+').replace(/_/g, '/');
          while (b.length % 4) b += '=';
          const bin = typeof atob === 'function' ? atob(b) : Buffer.from(b, 'base64').toString('binary');
          let out;
          try { out = decodeURIComponent(escape(bin)); } catch (e) { out = bin; }
          try { return JSON.parse(out); } catch (e) { /* ignore */ }
        } catch (e) { /* ignore */ }

        return null;
      }

      // attempt to process and (optionally) load shared payload string
      function processSharedParam(rawParam, askToLoad = true) {
        try {
          const parsed = parseShareString(rawParam);
          if (!parsed) return null;
          if (askToLoad) {
            if (confirm('В ссылке содержатся данные расчёта. Загрузить их и заменить текущие данные?')) {
              state = normalize(parsed);
              saveState();
              renderPeopleAndCategories();
              renderAll();
              renderScreen('Данные загружены из ссылки');

              // убрать ?data= из адресной строки, чтобы не импортировать повторно
              try { history.replaceState(null, document.title, location.pathname); } catch (e) { /* ignore */ }
            }
          }
          return parsed;
        } catch (e) { console.debug('[share] processSharedParam failed', e && e.message); return null; }
      }

      // on load: if ?data= present, try to parse and ask user to load
      (function checkSharedOnLoad() {
        try {
          const params = new URLSearchParams(location.search);
          const rawParam = params.get('data');
          if (!rawParam) return;
          const parsed = processSharedParam(rawParam, true);
          if (!parsed) {
            alert('Не удалось распознать данные в параметре `data`. Нажми «Поделиться» в приложении, чтобы получить рабочую ссылку, и пришли её мне.');
          }
        } catch (e) { /* ignore */ }
      })();

      // helper: produce alternative share formats (LZ and base64)
      function makeShareVariants() {
        try {
          const shareState = { people: state.people, categories: state.categories, expenses: state.expenses };
          const data = JSON.stringify(shareState);
          const lz = ShareCodec.encode(data);
          const base = (location.origin && location.origin !== 'null')
            ? (location.origin + location.pathname)
            : (location.pathname || '');
          const lzUrl = base + '?data=' + lz;
          // base64 (URL-safe) variant
          const b64raw = (typeof btoa === 'function') ? btoa(unescape(encodeURIComponent(data))) : Buffer.from(data, 'utf8').toString('base64');
          const b64url = b64raw.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
          const b64Url = base + '?data=' + b64url;
          return { lz, lzUrl, base64: b64url, base64Url: b64Url };
        } catch (e) { return null; }
      }
      try { window.makeShareVariants = makeShareVariants; } catch (e) { /* ignore */ }
      try { window.restoreFromShareString = (s) => processSharedParam(s, true); } catch (e) { /* ignore */ }

      function normalize(json) {
        const people = Array.isArray(json.people) ? json.people.map(String).filter(Boolean) : DEFAULT_STATE.people.slice();
        const categories = Array.isArray(json.categories) ? json.categories.map(String).filter(Boolean) : DEFAULT_STATE.categories.slice();

        let expenses = [];
        if (Array.isArray(json.expenses)) {
          expenses = json.expenses.map(e => ({
            id: e.id ? String(e.id) : uid(),
            ts: Number(e.ts) || Date.now(),
            date: e.date ? String(e.date) : nowIso(),
            payer: String(e.payer || ""),
            amount: round2(e.amount),
            reason: e.reason ? String(e.reason) : "",
            category: e.category ? String(e.category) : "",
            consumers: Array.isArray(e.consumers) ? e.consumers.map(String).filter(Boolean) : []
          })).filter(e => e.payer && e.amount > 0);
        } else if (Array.isArray(json.ops)) {
          // совместимость со старой версией: опция "кто должен → кому" превращаем в покупку
          expenses = json.ops.map(op => ({
            id: op.id ? String(op.id) : uid(),
            ts: Number(op.ts) || Date.now(),
            date: op.date ? String(op.date) : nowIso(),
            payer: String(op.to || ""),
            amount: round2(op.amount || 0),
            reason: op.reason ? String(op.reason) : "",
            category: op.category ? String(op.category) : "",
            consumers: op.from ? [String(op.from)] : []
          })).filter(e => e.payer && e.amount > 0);
        }

        const receipt = typeof json.receipt === "string" ? json.receipt : "";
        return { people, categories, expenses, receipt };
      }

      function saveState() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { }
      }

      // --- clock ---
      function tickClock() {
        const d = new Date();
        const pad = x => String(x).padStart(2, "0");
        screenClock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
      setInterval(tickClock, 250); tickClock();

      // --- amount buffer ---
      function setAmountBuffer(str) {
        str = String(str == null ? "0" : str);
        if (str === "" || str === "-") str = "0";
        str = str.replace(/,/g, ".");
        // только цифры и точка
        if (!/^[-0-9.]+$/.test(str)) {
          str = str.replace(/[^0-9.]/g, "");
        }
        const parts = str.split(".");
        if (parts.length > 2) str = parts[0] + "." + parts.slice(1).join("");
        if (str.includes(".")) {
          const [a, b] = str.split(".");
          str = a + "." + (b || "").slice(0, 2);
        }
        // убираем лидирующие нули
        if (str.startsWith("0") && !str.startsWith("0.")) {
          str = String(Number(str));
        }
        if (str === "NaN" || str === "") str = "0";
        amountBuffer = str;
        renderScreen();
      }

      function getAmount() {
        const n = Number(amountBuffer.replace(",", "."));
        return Number.isFinite(n) ? n : 0;
      }

      function renderScreen(msg) {
        const value = round2(getAmount());
        screenAmount.textContent = fmt.format(value);
        if (msg) {
          screenLine.textContent = msg;
        } else {
          screenLine.textContent = payerSel.value ? `Покупка: ${payerSel.value}` : "Готово к работе";
        }
      }

      // --- people & categories ---
      function renderPeopleAndCategories() {
        payerSel.innerHTML = "";
        state.people.forEach(p => {
          const o = document.createElement("option");
          o.value = p; o.textContent = p; payerSel.appendChild(o);
        });
        if (!payerSel.value && state.people.length) payerSel.value = state.people[0];

        categorySel.innerHTML = "";
        state.categories.forEach(c => {
          const o = document.createElement("option");
          o.value = c; o.textContent = c; categorySel.appendChild(o);
        });
        if (!categorySel.value && state.categories.length) categorySel.value = state.categories[0];

        renderConsumersCheckboxes();
        renderPeopleList();
        renderScreen();
      }

      function renderConsumersCheckboxes() {
        consumersBox.innerHTML = "";
        state.people.forEach(name => {
          const id = `c-${name.replace(/\s+/g, '-')}`;
          const label = document.createElement("label");
          label.htmlFor = id;
          label.innerHTML = `
            <input id="${id}" type="checkbox" class="consumer-checkbox" data-name="${escapeHtml(name)}" checked>
            <span>${escapeHtml(name)}</span>
            <span class="chip-actions" aria-hidden="true">
              <button type="button" class="chip-action edit" data-action="edit" data-name="${escapeHtml(name)}" title="Редактировать">✎</button>
              <button type="button" class="chip-action delete" data-action="delete" data-name="${escapeHtml(name)}" title="Удалить">✕</button>
            </span>
          `;
          consumersBox.appendChild(label);
        });
      }

      function renderPeopleList() {
        if (!peopleList) return;
        peopleList.innerHTML = "";
        if (!state.people.length) {
          const empty = document.createElement("div");
          empty.className = "people-empty";
          empty.textContent = "Пока нет участников. Добавь первого выше.";
          peopleList.appendChild(empty);
          return;
        }
        state.people.forEach(name => {
          const row = document.createElement("div");
          row.className = "person-row";

          const label = document.createElement("span");
          label.className = "person-name";
          label.textContent = name;

          const actions = document.createElement("div");
          actions.className = "person-actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-sm";
          editBtn.dataset.action = "edit";
          editBtn.dataset.name = name;
          editBtn.textContent = "Редактировать";

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-sm btn-danger";
          delBtn.dataset.action = "delete";
          delBtn.dataset.name = name;
          delBtn.textContent = "Удалить";

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          row.appendChild(label);
          row.appendChild(actions);
          peopleList.appendChild(row);
        });
      }

      function renamePerson(oldName, newName) {
        const clean = newName.trim();
        if (!clean) {
          renderScreen("Имя не может быть пустым");
          return;
        }
        if (clean === oldName) return;
        if (state.people.includes(clean)) {
          renderScreen("Такой участник уже есть");
          return;
        }
        state.people = state.people.map(p => (p === oldName ? clean : p));
        state.expenses.forEach(e => {
          if (e.payer === oldName) e.payer = clean;
          if (Array.isArray(e.consumers)) {
            e.consumers = e.consumers.map(c => (c === oldName ? clean : c));
          }
        });
        saveState();
        renderPeopleAndCategories();
        renderAll();
        printLine(`\nОбновлено имя: ${oldName} → ${clean}\n`);
      }

      function deletePerson(name) {
        if (!confirm(`Удалить участника "${name}"?`)) return;
        state.people = state.people.filter(p => p !== name);
        const remaining = state.people.slice();
        state.expenses.forEach(e => {
          if (e.payer === name) {
            e.payer = remaining[0] || "";
          }
          if (Array.isArray(e.consumers)) {
            e.consumers = e.consumers.filter(c => c !== name);
            if (!e.consumers.length && remaining.length) {
              e.consumers = remaining.slice();
            }
          }
        });
        saveState();
        renderPeopleAndCategories();
        renderAll();
        printLine(`\nУдалён участник: ${name}\n`);
      }

      function escapeHtml(str) {
        return String(str == null ? "" : str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function selectedConsumers() {
        const boxes = Array.from(document.querySelectorAll(".consumer-checkbox"));
        const chosen = boxes.filter(b => b.checked).map(b => b.getAttribute("data-name"));
        return chosen.length ? chosen : state.people.slice();
      }

      // --- expenses ---
      function addExpense() {
        const payer = payerSel.value || "";
        const amount = round2(getAmount());
        const date = (dateInp.value || "").trim() || nowIso();
        const category = categorySel.value || "";
        const reason = reasonInp.value.trim();
        if (!payer) { renderScreen("Укажи, кто платил"); return; }
        if (!(amount > 0)) { renderScreen("Сумма должна быть > 0"); return; }
        const consumers = selectedConsumers();

        const exp = { id: uid(), ts: Date.now(), date, payer, amount, category, reason, consumers };
        state.expenses.push(exp);
        saveState();
        printExpense(exp);
        setAmountBuffer("0");
        renderAll();
        renderScreen("Покупка добавлена");
      }

      function removeExpense(id) {
        const idx = state.expenses.findIndex(e => e.id === id);
        if (idx >= 0) {
          const e = state.expenses[idx];
          state.expenses.splice(idx, 1);
          saveState();
          printLine(`\nУдалена покупка: ${e.payer} — ${fmtRub(e.amount)} (${e.reason || e.category || "без комментария"})\n`);
          renderAll();
        }
      }

      function renderExpenses() {
        expensesTbody.innerHTML = "";
        if (!state.expenses.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="6" style="font-size:12px;color:var(--muted);padding:10px 9px;">Пока покупок нет.</td>`;
          expensesTbody.appendChild(tr);
          return;
        }
        const sorted = [...state.expenses].sort((a, b) => (a.ts || 0) - (b.ts || 0));
        for (const e of sorted) {
          const tr = document.createElement("tr");
          const who = escapeHtml(e.payer);
          const descr = escapeHtml([e.category, e.reason].filter(Boolean).join(" • ")) || "—";
          let consumersText;
          const allNames = state.people.slice().sort();
          const uniqueConsumers = Array.from(new Set(e.consumers || []));
          if (uniqueConsumers.length === 0 || uniqueConsumers.length === allNames.length) {
            consumersText = "все участники";
          } else {
            consumersText = uniqueConsumers.join(", ");
          }
          tr.innerHTML = `
          <td class="mono">${escapeHtml(e.date)}</td>
          <td>${who}</td>
          <td class="mono right">${fmtRub(e.amount)}</td>
          <td>${descr}</td>
          <td>${escapeHtml(consumersText)}</td>
          <td class="right"><button class="chip-action delete" title="Удалить покупку" aria-label="Удалить покупку" data-del="${e.id}">✕</button></td>
        `;
          expensesTbody.appendChild(tr);
        }
        expensesTbody.querySelectorAll("[data-del]").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-del");
            removeExpense(id);
          });
        });
      }

      // --- balances & settlement ---
      function calcBalances() {
        const map = new Map();
        const ensure = name => {
          if (!map.has(name)) map.set(name, { name, paid: 0, used: 0, bal: 0 });
          return map.get(name);
        };

        state.people.forEach(p => ensure(p));

        for (const e of state.expenses) {
          const amount = Number(e.amount) || 0; if (!(amount > 0)) continue;
          const payer = e.payer;
          let consumers = Array.isArray(e.consumers) && e.consumers.length ? e.consumers.slice() : state.people.slice();
          consumers = consumers.filter(Boolean);
          if (consumers.length === 0) consumers = state.people.slice();

          const n = consumers.length; if (!n) continue;
          const share = round2(amount / n);

          const payerRow = ensure(payer); payerRow.paid = round2(payerRow.paid + amount);

          consumers.forEach(name => {
            const row = ensure(name);
            row.used = round2(row.used + share);
            if (name !== payer) {
              payerRow.bal = round2(payerRow.bal + share);
              row.bal = round2(row.bal - share);
            }
          });
        }

        // итоговый список в порядке людей из справочника
        const res = [];
        state.people.forEach(p => { if (map.has(p)) res.push(map.get(p)); });
        for (const [name, row] of map.entries()) {
          if (!state.people.includes(name)) res.push(row);
        }
        return res;
      }

      function suggestSettlement(balances) {
        const creditors = balances.filter(x => x.bal > 0.0001).map(x => ({ name: x.name, amt: round2(x.bal) }));
        const debtors = balances.filter(x => x.bal < -0.0001).map(x => ({ name: x.name, amt: round2(-x.bal) }));
        creditors.sort((a, b) => b.amt - a.amt);
        debtors.sort((a, b) => b.amt - a.amt);
        const res = [];
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
          const d = debtors[i], c = creditors[j];
          const pay = round2(Math.min(d.amt, c.amt));
          if (pay > 0.0001) {
            res.push({ from: d.name, to: c.name, amount: pay });
            d.amt = round2(d.amt - pay);
            c.amt = round2(c.amt - pay);
          }
          if (d.amt <= 0.0001) i++;
          if (c.amt <= 0.0001) j++;
        }
        return res;
      }

      function renderBalancesAndSettlement() {
        const balances = calcBalances();
        const transfers = suggestSettlement(balances);

        balancesBox.innerHTML = "";
        if (!balances.length) {
          balancesBox.innerHTML = `<div class="note">Пока никого нет в списке участников.</div>`;
        } else {
          const maxAbs = Math.max(1, ...balances.map(b => Math.abs(b.bal)));
          balances.forEach(b => {
            const card = document.createElement("div");
            card.className = "bcard";
            const status = b.bal > 0.0001 ? "pos" : (b.bal < -0.0001 ? "neg" : "zero");
            const badgeClass = status === "pos" ? "badge badge-pos" : (status === "neg" ? "badge badge-neg" : "badge badge-zero");
            const badgeText = status === "pos" ? "Получить" : (status === "neg" ? "Отдать" : "В нуле");
            const width = Math.round(Math.min(100, Math.abs(b.bal) / maxAbs * 100));
            card.innerHTML = `
            <div class="bcard-header">
              <div class="bcard-name">${escapeHtml(b.name)}</div>
              <div class="${badgeClass}">${badgeText}</div>
            </div>
            <div class="bcard-line">Потратил: <b>${fmtRub(b.paid)}</b></div>
            <div class="bcard-line">Получил бенефитов: <b>${fmtRub(b.used)}</b></div>
            <div class="bcard-line">Баланс: <b>${fmtRub(b.bal)}</b></div>
            <div class="bar-wrap"><div class="bar" style="width:${width}%"></div></div>
          `;
            balancesBox.appendChild(card);
          });
        }

        const sum = round2(balances.reduce((s, b) => s + b.bal, 0));
        const totalSpent = round2(state.expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0));
        if (!state.expenses.length) {
          summaryNote.textContent = "Пока покупок нет.";
        } else if (Math.abs(sum) < 0.01) {
          summaryNote.textContent = `Всего покупок на ${fmtRub(totalSpent)}. Сумма балансов сошлась в ноль (ок).`;
        } else {
          summaryNote.textContent = `Всего покупок на ${fmtRub(totalSpent)}. Внимание: сумма балансов = ${fmtRub(sum)} (скорее всего где-то опечатка).`;
        }

        settlementTbody.innerHTML = "";
        if (!transfers.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="4" style="font-size:12px;color:var(--muted);padding:9px;">Переводы не нужны — все уже в нуле.</td>`;
          settlementTbody.appendChild(tr);
        } else {
          transfers.forEach(t => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${escapeHtml(t.from)}</td>
            <td>${escapeHtml(t.to)}</td>
            <td class="mono right">${fmtRub(t.amount)}</td>
            <td>закрывает часть сальдо</td>
          `;
            settlementTbody.appendChild(tr);
          });
        }
      }

      // --- receipt ---
      function printLine(text) {
        state.receipt += text;
        if (state.receipt.length > 20000) {
          state.receipt = state.receipt.slice(-20000);
        }
        saveState();
        renderReceipt();
      }

      function receiptHeader(title) {
        const hr = "-".repeat(32);
        const d = new Date();
        const pad = x => String(x).padStart(2, "0");
        const stamp = `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        return `\n${hr}\n${center(title, 32)}\n${center("КАССА ВЗАИМОРАСЧЁТЫ", 32)}\n${center(stamp, 32)}\n${hr}\n`;
      }

      function center(s, w) {
        s = String(s);
        if (s.length >= w) return s.slice(0, w);
        const left = Math.floor((w - s.length) / 2);
        const right = w - s.length - left;
        return " ".repeat(left) + s + " ".repeat(right);
      }

      function printExpense(e) {
        const hr = "-".repeat(32);
        const consumers = (e.consumers && e.consumers.length) ? e.consumers.join(", ") : "все участники";
        const body = [
          receiptHeader("ПОКУПКА"),
          `Дата: ${e.date}`,
          `Платил: ${e.payer}`,
          `Сумма: ${fmtRub(e.amount)}`,
          `Категория: ${e.category || "—"}`,
          `Комментарий: ${e.reason || "—"}`,
          `Делим на: ${consumers}`,
          hr,
          center("СПАСИБО", 32),
          ""
        ].join("\n");
        printLine(body);
      }

      function printSettlementReceipt() {
        const balances = calcBalances();
        const transfers = suggestSettlement(balances);
        const hr = "-".repeat(32);
        const lines = [];
        lines.push(receiptHeader("ВЗАИМОЗАЧЁТ"));
        lines.push("Сальдо (получить/отдать):");
        balances.forEach(b => {
          const sign = b.bal > 0.0001 ? "+" : (b.bal < -0.0001 ? "-" : " ");
          lines.push(`${padRight(b.name, 14)} ${sign}${fmt.format(Math.abs(b.bal))} ₽`);
        });
        lines.push(hr);
        lines.push("Переводы:");
        if (!transfers.length) {
          lines.push(center("не нужны", 32));
        } else {
          let i = 1;
          transfers.forEach(t => {
            const left = `${i}) ${t.from}→${t.to}`;
            const right = `${fmt.format(t.amount)} ₽`;
            lines.push(padRight(left, 22) + padLeft(right, 10));
            i++;
          });
        }
        const sum = round2(balances.reduce((s, b) => s + b.bal, 0));
        lines.push(hr);
        lines.push(`Проверка Σ: ${fmt.format(sum)} ₽`);
        lines.push(hr);
        lines.push(center("КОНЕЦ ЧЕКА", 32));
        lines.push("");
        printLine(lines.join("\n"));
      }

      function padRight(s, w) { s = String(s); return s.length >= w ? s.slice(0, w) : s + " ".repeat(w - s.length); }
      function padLeft(s, w) { s = String(s); return s.length >= w ? s.slice(0, w) : " ".repeat(w - s.length) + s; }

      function renderReceipt() {
        receiptBody.textContent = state.receipt.trimStart();
        if (!state.receipt) {
          receiptStats.textContent = "—";
        } else {
          const lines = state.receipt.split("\n");
          receiptStats.textContent = `Строк: ${lines.length} • Символов: ${state.receipt.length}`;
        }
        const el = receiptBody.parentElement;
        el.scrollTop = el.scrollHeight;
      }

      // --- keypad ---
      function handleKey(key) {
        if (key === "C") { setAmountBuffer("0"); return; }
        if (key === "BS") {
          if (amountBuffer.length <= 1) { setAmountBuffer("0"); } else { setAmountBuffer(amountBuffer.slice(0, -1)); }
          return;
        }
        if (key === "ENTER") { addExpense(); return; }
        if (key === "TODAY") { dateInp.value = nowIso(); renderScreen("Дата: сегодня"); return; }
        if (key === "ALL") {
          document.querySelectorAll(".consumer-checkbox").forEach(c => c.checked = true);
          renderScreen("Делим на всех");
          return;
        }
        if (key === "NONE") {
          document.querySelectorAll(".consumer-checkbox").forEach(c => c.checked = false);
          renderScreen("Нужно выбрать, на кого делим");
          return;
        }
        if (key === "X2") {
          const val = getAmount();
          setAmountBuffer(String(round2(val * 2)));
          return;
        }
        if (key === "." || key === ",") {
          if (!amountBuffer.includes(".")) setAmountBuffer(amountBuffer + ".");
          return;
        }
        if (/^\d+$/.test(key)) {
          if (amountBuffer === "0") setAmountBuffer(key);
          else setAmountBuffer(amountBuffer + key);
          return;
        }
        if (key === "00") {
          if (amountBuffer === "0") setAmountBuffer("0");
          else setAmountBuffer(amountBuffer + "00");
          return;
        }
      }

      keypadButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.getAttribute("data-key");
          handleKey(k);
        });
      });

      document.addEventListener("keydown", e => {
        const active = document.activeElement;
        const tag = active ? active.tagName.toLowerCase() : "";
        const inInput = tag === "input" || tag === "textarea" || tag === "select";

        if (e.key === "Enter") {
          if (!inInput || active === reasonInp || active === dateInp) {
            e.preventDefault();
            addExpense();
          }
          return;
        }
        if (e.key === "Escape") {
          e.preventDefault();
          setAmountBuffer("0");
          return;
        }
        if (!inInput) {
          if (e.key === "Backspace") {
            e.preventDefault(); handleKey("BS"); return;
          }
          if (/^[0-9]$/.test(e.key)) {
            e.preventDefault(); handleKey(e.key); return;
          }
          if (e.key === "," || e.key === ".") {
            e.preventDefault(); handleKey("."); return;
          }
        }
      });

      // --- buttons ---
      btnAddPerson.addEventListener("click", () => {
        const name = newPersonInp.value.trim();
        if (!name) return;
        if (state.people.includes(name)) {
          renderScreen("Такой участник уже есть");
          return;
        }
        state.people.push(name);
        newPersonInp.value = "";
        saveState();
        renderPeopleAndCategories();
        renderAll();
        printLine(`\nДобавлен участник: ${name}\n`);
      });

      if (peopleList) {
        peopleList.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const btn = target.closest("button");
          if (!btn || !peopleList.contains(btn)) return;
          const action = btn.dataset.action;
          const name = btn.dataset.name;
          if (!name || !action) return;
          if (action === "edit") {
            const next = prompt("Новое имя участника:", name);
            if (next === null) return;
            renamePerson(name, next);
          }
          if (action === "delete") {
            deletePerson(name);
          }
        });
      }

      if (consumersBox) {
        consumersBox.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;

          const btn = target.closest("button.chip-action");
          if (!btn || !consumersBox.contains(btn)) return;

          // Кнопки находятся внутри <label>, поэтому предотвращаем переключение чекбокса.
          event.preventDefault();
          event.stopPropagation();

          const action = btn.dataset.action;
          const name = btn.dataset.name;
          if (!name || !action) return;

          if (action === "edit") {
            const next = prompt("Новое имя участника:", name);
            if (next === null) return;
            renamePerson(name, next);
          }
          if (action === "delete") {
            deletePerson(name);
          }
        });
      }

      btnClearReceipt.addEventListener("click", () => {
        if (!confirm("Очистить ленту чеков?")) return;
        state.receipt = ""; saveState(); renderReceipt();
      });

      btnPrintSettlement.addEventListener("click", () => {
        printSettlementReceipt();
      });

      btnClearExpenses.addEventListener("click", () => {
        if (!state.expenses.length) return;
        if (!confirm("Удалить все покупки?")) return;
        state.expenses = []; saveState(); renderAll();
        printLine(receiptHeader("СБРОС") + "Все покупки удалены.\n");
      });

      btnDemo.addEventListener("click", () => {
        const d = nowIso();
        // пример, соответствующий твоим данным
        const all = ["Миша", "Дима", "Валерия", "Лёша К.", "Лёша Г."];
        const ex = [
          { payer: "Миша", amount: 420 * 5, category: "алкоголь", reason: "алкоголь", consumers: all },
          { payer: "Дима", amount: 354 * 5, category: "снэки", reason: "чипсы/орешки", consumers: all },
          { payer: "Лёша Г.", amount: 600 * 3, category: "пицца/еда", reason: "пицца", consumers: ["Миша", "Валерия", "Лёша К."] },
          { payer: "Дима", amount: 385 * 3, category: "бар/кафе", reason: "бар", consumers: ["Миша", "Валерия", "Лёша Г."] }
        ];
        ex.forEach(e => state.expenses.push({ id: uid(), ts: Date.now() + Math.random() * 1000, date: d, payer: e.payer, amount: e.amount, category: e.category, reason: e.reason, consumers: e.consumers.slice() }));
        saveState();
        printLine(receiptHeader("ДЕМО") + "Загружен пример по алкоголю/чипсам/пицце/бару.\n");
        renderAll();
      });

      // --- render all ---
      function renderAll() {
        renderExpenses();
        renderBalancesAndSettlement();
        renderReceipt();
      }

      // init
      renderPeopleAndCategories();
      if (!state.receipt) {
        state.receipt = receiptHeader("СТАРТ") + "Готово к работе.\n";
        saveState();
      }
      setAmountBuffer("0");
      renderAll();

      // Автозапуск тура при первом заходе
      if (!wasTourSeen()) {
        setTimeout(() => {
          try { startTour(); } catch (e) { /* ignore */ }
        }, 350);
      }
    })();
  </script>
</body>

</html>
